version: '3.8'

services:
  # æœ¬åœ°èªè­‰æ¸¬è©¦ç’°å¢ƒ
  fintranzo-local-auth-test:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=test
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ  æœ¬åœ°èªè­‰æ¸¬è©¦ç’°å¢ƒ' &&
        echo '==================' &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£ä¾è³´...' &&
        yarn install --frozen-lockfile &&
        echo '' &&
        echo 'ğŸ§ª é–‹å§‹æœ¬åœ°èªè­‰æ¸¬è©¦...' &&
        node scripts/test-local-auth-simple.js &&
        echo '' &&
        echo 'âœ… æœ¬åœ°èªè­‰æ¸¬è©¦å®Œæˆ'
      "

  # æ··åˆèªè­‰æ¸¬è©¦ç’°å¢ƒ
  fintranzo-hybrid-auth-test:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=test
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ”„ æ··åˆèªè­‰æ¸¬è©¦ç’°å¢ƒ' &&
        echo '==================' &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£ä¾è³´...' &&
        yarn install --frozen-lockfile &&
        echo '' &&
        echo 'ğŸ§ª æ¸¬è©¦1: æœ¬åœ°èªè­‰...' &&
        node scripts/test-local-auth-simple.js &&
        echo '' &&
        echo 'ğŸ§ª æ¸¬è©¦2: Supabase é€£æ¥...' &&
        node scripts/check-supabase-auth-settings.js &&
        echo '' &&
        echo 'âœ… æ··åˆèªè­‰æ¸¬è©¦å®Œæˆ'
      "

  # Web ç’°å¢ƒèªè­‰æ¸¬è©¦ï¼ˆå¸¶ UIï¼‰
  fintranzo-auth-web-test:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
      - "8081:8081"
    environment:
      - NODE_ENV=development
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM
      - EXPO_PUBLIC_REDIRECT_URL=http://localhost:8081
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸŒ Web èªè­‰æ¸¬è©¦ç’°å¢ƒ' &&
        echo '==================' &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£ä¾è³´...' &&
        yarn install --frozen-lockfile &&
        echo '' &&
        echo 'ğŸ§ª å…ˆé‹è¡Œèªè­‰æ¸¬è©¦...' &&
        node scripts/docker-auth-test.js &&
        echo '' &&
        echo 'ğŸŒ å•Ÿå‹• Web æœå‹™...' &&
        echo 'è¨ªå• http://localhost:3000 é€²è¡Œæ‰‹å‹•æ¸¬è©¦' &&
        npx expo start --web --port 8081 --host 0.0.0.0
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ç”¨æˆ¶ç¢ºèªå·¥å…·
  fintranzo-user-confirm:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=development
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ”§ ç”¨æˆ¶ç¢ºèªå·¥å…·' &&
        echo '==============' &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£ä¾è³´...' &&
        yarn install --frozen-lockfile &&
        echo '' &&
        echo 'ğŸ“‹ åˆ—å‡ºæœªç¢ºèªç”¨æˆ¶...' &&
        node scripts/confirm-user.js list &&
        echo '' &&
        echo 'ğŸ’¡ ä½¿ç”¨æ–¹æ³•:' &&
        echo '  ç¢ºèªç”¨æˆ¶: docker-compose -f docker-compose.auth-test.yml exec fintranzo-user-confirm node scripts/confirm-user.js confirm email@example.com' &&
        echo '  æ¸¬è©¦ç™»éŒ„: docker-compose -f docker-compose.auth-test.yml exec fintranzo-user-confirm node scripts/confirm-user.js test email@example.com password' &&
        echo '' &&
        echo 'â³ ä¿æŒå®¹å™¨é‹è¡Œä»¥ä¾›äº¤äº’ä½¿ç”¨...' &&
        tail -f /dev/null
      "

  # å¤šè¼ªèªè­‰æ¸¬è©¦
  fintranzo-auth-stress-test:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=test
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ”„ å¤šè¼ªèªè­‰å£“åŠ›æ¸¬è©¦' &&
        echo '==================' &&
        echo '' &&
        echo 'ğŸ“¦ å®‰è£ä¾è³´...' &&
        yarn install --frozen-lockfile &&
        echo '' &&
        for i in \$$(seq 1 5); do
          echo \"ğŸ§ª ç¬¬ \$$i è¼ªèªè­‰æ¸¬è©¦...\" &&
          node scripts/docker-auth-test.js &&
          echo \"âœ… ç¬¬ \$$i è¼ªæ¸¬è©¦å®Œæˆ\" &&
          echo '' &&
          sleep 3
        done &&
        echo 'ğŸ‰ æ‰€æœ‰èªè­‰æ¸¬è©¦å®Œæˆ'
      "

networks:
  default:
    driver: bridge

volumes:
  node_modules:
    driver: local
