apiVersion: batch/v1
kind: Job
metadata:
  name: fintranzo-validation-job
  labels:
    app: fintranzo-validation
    test-iteration: "8"
spec:
  template:
    metadata:
      labels:
        app: fintranzo-validation
        test-iteration: "8"
    spec:
      restartPolicy: Never
      containers:
      - name: fintranzo-validator
        image: fintranzo:latest
        command: ["/bin/bash"]
        args: ["-c", "
          echo 'ğŸ¯ ç¬¬8æ¬¡æ¸¬è©¦ï¼šKubernetesé©—è­‰';
          echo '============================';
          
          # è¨­ç½®ç’°å¢ƒ
          export NODE_ENV=test;
          export EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co;
          export EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM;
          
          # é©—è­‰1: åŸºç¤é€£æ¥
          echo 'ğŸ”Œ é©—è­‰1: åŸºç¤é€£æ¥';
          node -e \"
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(process.env.EXPO_PUBLIC_SUPABASE_URL, process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY);
            supabase.auth.signInWithPassword({email: 'user01@gmail.com', password: 'user01'})
              .then(r => {
                if (r.error) {
                  console.log('âŒ é€£æ¥å¤±æ•—:', r.error.message);
                  process.exit(1);
                } else {
                  console.log('âœ… é€£æ¥æˆåŠŸ');
                  process.exit(0);
                }
              })
              .catch(e => {
                console.log('âŒ é€£æ¥ç•°å¸¸:', e.message);
                process.exit(1);
              });
          \" || exit 1;
          
          # é©—è­‰2: æœå‹™æ–‡ä»¶
          echo 'ğŸ“ é©—è­‰2: æœå‹™æ–‡ä»¶';
          if [ -f 'src/services/realTimeSyncService.ts' ]; then
            echo 'âœ… realTimeSyncService.ts å­˜åœ¨';
          else
            echo 'âŒ realTimeSyncService.ts ä¸å­˜åœ¨';
            exit 1;
          fi;
          
          if [ -f 'src/services/liabilityService.ts' ]; then
            echo 'âœ… liabilityService.ts å­˜åœ¨';
          else
            echo 'âŒ liabilityService.ts ä¸å­˜åœ¨';
            exit 1;
          fi;
          
          # é©—è­‰3: è² å‚µæ•¸æ“š
          echo 'ğŸ’³ é©—è­‰3: è² å‚µæ•¸æ“š';
          node -e \"
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(process.env.EXPO_PUBLIC_SUPABASE_URL, process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY);
            (async () => {
              try {
                const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
                  email: 'user01@gmail.com',
                  password: 'user01'
                });
                
                if (loginError) {
                  console.log('âŒ ç™»éŒ„å¤±æ•—');
                  process.exit(1);
                }
                
                const { data: liabilities, error: liabilityError } = await supabase
                  .from('liabilities')
                  .select('*')
                  .eq('user_id', loginData.user.id);
                
                if (liabilityError) {
                  console.log('âŒ è² å‚µæŸ¥è©¢å¤±æ•—:', liabilityError.message);
                  process.exit(1);
                }
                
                console.log('âœ… è² å‚µæŸ¥è©¢æˆåŠŸï¼Œæ•¸é‡:', liabilities?.length || 0);
                process.exit(0);
              } catch (error) {
                console.log('âŒ é©—è­‰ç•°å¸¸:', error.message);
                process.exit(1);
              }
            })();
          \" || exit 1;
          
          # é©—è­‰4: è³‡ç”¢æ•¸æ“š
          echo 'ğŸ’° é©—è­‰4: è³‡ç”¢æ•¸æ“š';
          node -e \"
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(process.env.EXPO_PUBLIC_SUPABASE_URL, process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY);
            (async () => {
              try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                  console.log('âŒ ç”¨æˆ¶æœªç™»éŒ„');
                  process.exit(1);
                }
                
                const { data: assets, error: assetError } = await supabase
                  .from('assets')
                  .select('*')
                  .eq('user_id', user.id);
                
                if (assetError) {
                  console.log('âŒ è³‡ç”¢æŸ¥è©¢å¤±æ•—:', assetError.message);
                  process.exit(1);
                }
                
                console.log('âœ… è³‡ç”¢æŸ¥è©¢æˆåŠŸï¼Œæ•¸é‡:', assets?.length || 0);
                process.exit(0);
              } catch (error) {
                console.log('âŒ é©—è­‰ç•°å¸¸:', error.message);
                process.exit(1);
              }
            })();
          \" || exit 1;
          
          # é©—è­‰5: äº¤æ˜“æ•¸æ“š
          echo 'ğŸ“ é©—è­‰5: äº¤æ˜“æ•¸æ“š';
          node -e \"
            const { createClient } = require('@supabase/supabase-js');
            const supabase = createClient(process.env.EXPO_PUBLIC_SUPABASE_URL, process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY);
            (async () => {
              try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                  console.log('âŒ ç”¨æˆ¶æœªç™»éŒ„');
                  process.exit(1);
                }
                
                const { data: transactions, error: transactionError } = await supabase
                  .from('transactions')
                  .select('*')
                  .eq('user_id', user.id)
                  .limit(5);
                
                if (transactionError) {
                  console.log('âŒ äº¤æ˜“æŸ¥è©¢å¤±æ•—:', transactionError.message);
                  process.exit(1);
                }
                
                console.log('âœ… äº¤æ˜“æŸ¥è©¢æˆåŠŸï¼Œæ•¸é‡:', transactions?.length || 0);
                process.exit(0);
              } catch (error) {
                console.log('âŒ é©—è­‰ç•°å¸¸:', error.message);
                process.exit(1);
              }
            })();
          \" || exit 1;
          
          echo 'ğŸ‰ ç¬¬8æ¬¡Kubernetesé©—è­‰å®Œæˆï¼';
          echo 'æ‰€æœ‰é©—è­‰é …ç›®é€šé';
        "]
        env:
        - name: NODE_ENV
          value: "test"
        - name: EXPO_PUBLIC_SUPABASE_URL
          value: "https://yrryyapzkgrsahranzvo.supabase.co"
        - name: EXPO_PUBLIC_SUPABASE_ANON_KEY
          value: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM"
        - name: TEST_USER_EMAIL
          value: "user01@gmail.com"
        - name: TEST_USER_PASSWORD
          value: "user01"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: validation-results
          mountPath: /app/validation-results
      volumes:
      - name: validation-results
        emptyDir: {}
  backoffLimit: 2
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: validation-config
data:
  validation-script: |
    #!/bin/bash
    echo "ğŸ¯ Kubernetesé©—è­‰è…³æœ¬"
    echo "===================="
    
    # æª¢æŸ¥ç’°å¢ƒè®Šé‡
    if [ -z "$EXPO_PUBLIC_SUPABASE_URL" ]; then
      echo "âŒ SUPABASE_URL æœªè¨­ç½®"
      exit 1
    fi
    
    if [ -z "$EXPO_PUBLIC_SUPABASE_ANON_KEY" ]; then
      echo "âŒ SUPABASE_ANON_KEY æœªè¨­ç½®"
      exit 1
    fi
    
    echo "âœ… ç’°å¢ƒè®Šé‡æª¢æŸ¥é€šé"
    
    # æª¢æŸ¥Node.js
    if command -v node &> /dev/null; then
      echo "âœ… Node.js å¯ç”¨: $(node --version)"
    else
      echo "âŒ Node.js ä¸å¯ç”¨"
      exit 1
    fi
    
    # æª¢æŸ¥ä¾è³´
    if [ -d "node_modules/@supabase/supabase-js" ]; then
      echo "âœ… Supabase ä¾è³´å¯ç”¨"
    else
      echo "âŒ Supabase ä¾è³´ä¸å¯ç”¨"
      exit 1
    fi
    
    echo "ğŸ‰ æ‰€æœ‰æª¢æŸ¥é€šéï¼"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: fintranzo-periodic-validation
spec:
  schedule: "0 */4 * * *"  # æ¯4å°æ™‚é‹è¡Œä¸€æ¬¡
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: fintranzo-periodic-validation
        spec:
          restartPolicy: OnFailure
          containers:
          - name: fintranzo-validator
            image: fintranzo:latest
            command: ["/bin/bash"]
            args: ["/app/scripts/enhanced-docker-test.sh"]
            env:
            - name: NODE_ENV
              value: "test"
            - name: EXPO_PUBLIC_SUPABASE_URL
              value: "https://yrryyapzkgrsahranzvo.supabase.co"
            - name: EXPO_PUBLIC_SUPABASE_ANON_KEY
              value: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM"
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
