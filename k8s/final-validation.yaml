apiVersion: batch/v1
kind: Job
metadata:
  name: fintranzo-two-issues-validation
  namespace: default
  labels:
    app: fintranzo
    component: two-issues-validation
    version: v1.1.0
    test-type: two-critical-issues
spec:
  ttlSecondsAfterFinished: 7200  # 2å°æ™‚å¾Œæ¸…ç†
  backoffLimit: 2
  activeDeadlineSeconds: 600  # 10åˆ†é˜è¶…æ™‚
  template:
    metadata:
      labels:
        app: fintranzo
        component: final-validation
        test-type: seven-issues
    spec:
      restartPolicy: Never
      containers:
      - name: final-validator
        image: node:18-alpine
        command: ["/bin/sh"]
        args:
          - -c
          - |
            echo "ğŸ¯ FinTranzo Two Critical Issues Validation"
            echo "==========================================="
            echo "é–‹å§‹æ™‚é–“: $(date)"
            echo "Kubernetes Pod: $HOSTNAME"
            echo "æ¸¬è©¦é¡å‹: å…©å€‹é—œéµå•é¡Œä¿®å¾©é©—è­‰"

            # å®‰è£ä¾è³´
            echo "ğŸ“¦ å®‰è£ä¾è³´..."
            npm install @supabase/supabase-js

            # å‰µå»ºå…©å€‹å•é¡Œé©—è­‰è…³æœ¬
            cat > two-issues-validation.js << 'EOF'
            const { createClient } = require('@supabase/supabase-js');
            
            console.log('ğŸš€ é–‹å§‹å…©å€‹é—œéµå•é¡Œé©—è­‰...');
            console.log('æ¸¬è©¦ç’°å¢ƒ: Kubernetes');
            console.log('æ¸¬è©¦æ™‚é–“:', new Date().toLocaleString());
            console.log('å•é¡Œ1: ä¸€éµåˆªé™¤åªæœƒåˆªé™¤å„€è¡¨æ¿çš„è¿‘ä¸€å¹´è³‡ç”¢è®ŠåŒ–ï¼Œå…¶ä»–éƒ½ä¸æœƒåˆª');
            console.log('å•é¡Œ2: å‰µå»ºè² å‚µå¾Œæœˆæ›†ä¸Šæœƒé‡è¤‡å‡ºç¾å…©ç­†ä¸€æ¨£çš„å…§å®¹ï¼Œåªè¦ç•™ä¸€ç­†');
            
            const supabase = createClient(
              'https://yrryyapzkgrsahranzvo.supabase.co',
              'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNzM2MzUsImV4cCI6MjA2Mzc0OTYzNX0.TccJJ9KGG6R4KiaDb-548kRkhTaPMODYa6vlQsj8dmM'
            );
            
            function generateUUID() {
              return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
              });
            }
            
            async function runFinalValidation() {
              try {
                // ç™»éŒ„æ¸¬è©¦
                console.log('\nğŸ” ç™»éŒ„æ¸¬è©¦...');
                const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
                  email: 'user01@gmail.com',
                  password: 'user01'
                });
                
                if (loginError) {
                  console.log('âŒ ç™»éŒ„å¤±æ•—:', loginError.message);
                  process.exit(1);
                }
                
                const userId = loginData.user.id;
                console.log('âœ… ç™»éŒ„æˆåŠŸ, ç”¨æˆ¶ID:', userId);
                
                let results = {
                  issue1: false, // è² å‚µæœˆæ›†äº¤æ˜“é¡¯ç¤º
                  issue2: false, // è² å‚µåŒæ­¥åˆ°SUPABASE
                  issue3: false, // ä¸€éµåˆªé™¤åŒæ­¥åˆ°SUPABASE
                  issue4: false, // è³‡ç”¢é¡¯ç¤ºç©©å®šæ€§
                  issue5: false, // è³‡ç”¢é‡è¤‡ä¸Šå‚³æ§åˆ¶
                  issue6: false, // äº¤æ˜“è³‡ç”¢é¡¯ç¤º
                  issue7: false  // å„€éŒ¶æ¿é¡¯ç¤º5ç­†
                };
                
                // å•é¡Œ1: è² å‚µæœˆæ›†äº¤æ˜“é¡¯ç¤º
                console.log('\nğŸ’³ å•é¡Œ1: è² å‚µæœˆæ›†äº¤æ˜“é¡¯ç¤º');
                try {
                  const testLiability = {
                    id: generateUUID(),
                    user_id: userId,
                    name: 'K8sæœ€çµ‚æ¸¬è©¦è² å‚µ',
                    type: 'credit_card',
                    balance: 50000,
                    monthly_payment: 3000,
                    payment_day: 15,
                    payment_account: 'éŠ€è¡Œå¸³æˆ¶'
                  };
                  
                  const { error: liabilityError } = await supabase
                    .from('liabilities')
                    .insert(testLiability);
                  
                  if (!liabilityError) {
                    // ç­‰å¾…å¾ªç’°äº¤æ˜“å‰µå»º
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // æª¢æŸ¥æœˆæ›†äº¤æ˜“
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    const monthStart = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-01`;
                    const monthEnd = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-31`;
                    
                    const { data: transactions, error: transactionError } = await supabase
                      .from('transactions')
                      .select('*')
                      .eq('user_id', userId)
                      .eq('category', 'é‚„æ¬¾')
                      .gte('date', monthStart)
                      .lte('date', monthEnd);
                    
                    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
                    await supabase.from('liabilities').delete().eq('id', testLiability.id);
                    
                    if (!transactionError && transactions && transactions.length > 0) {
                      console.log('âœ… å•é¡Œ1: å·²ä¿®å¾© (æ‰¾åˆ°æœˆæ›†äº¤æ˜“)');
                      results.issue1 = true;
                    } else {
                      console.log('âŒ å•é¡Œ1: ä»å­˜åœ¨ (æœªæ‰¾åˆ°æœˆæ›†äº¤æ˜“)');
                    }
                  } else {
                    console.log('âŒ å•é¡Œ1: è² å‚µå‰µå»ºå¤±æ•— -', liabilityError.message);
                  }
                } catch (error) {
                  console.log('âŒ å•é¡Œ1: æ¸¬è©¦ç•°å¸¸ -', error.message);
                }
                
                // å•é¡Œ2: è² å‚µåŒæ­¥åˆ°SUPABASE
                console.log('\nğŸ”„ å•é¡Œ2: è² å‚µåŒæ­¥åˆ°SUPABASE');
                try {
                  const testLiability = {
                    id: generateUUID(),
                    user_id: userId,
                    name: 'K8såŒæ­¥æ¸¬è©¦è² å‚µ',
                    type: 'loan',
                    balance: 100000,
                    interest_rate: 0.05
                  };
                  
                  const { error: insertError } = await supabase
                    .from('liabilities')
                    .insert(testLiability);
                  
                  if (!insertError) {
                    // æ¸¬è©¦æ›´æ–°
                    const { error: updateError } = await supabase
                      .from('liabilities')
                      .update({ balance: 90000 })
                      .eq('id', testLiability.id);
                    
                    // æ¸¬è©¦åˆªé™¤
                    const { error: deleteError } = await supabase
                      .from('liabilities')
                      .delete()
                      .eq('id', testLiability.id);
                    
                    if (!updateError && !deleteError) {
                      console.log('âœ… å•é¡Œ2: å·²ä¿®å¾© (CRUDæ“ä½œæ­£å¸¸)');
                      results.issue2 = true;
                    } else {
                      console.log('âŒ å•é¡Œ2: ä»å­˜åœ¨ (CRUDæ“ä½œå¤±æ•—)');
                    }
                  } else {
                    console.log('âŒ å•é¡Œ2: è² å‚µæ’å…¥å¤±æ•— -', insertError.message);
                  }
                } catch (error) {
                  console.log('âŒ å•é¡Œ2: æ¸¬è©¦ç•°å¸¸ -', error.message);
                }
                
                // å•é¡Œ3: ä¸€éµåˆªé™¤åŒæ­¥åˆ°SUPABASE
                console.log('\nğŸ—‘ï¸ å•é¡Œ3: ä¸€éµåˆªé™¤åŒæ­¥åˆ°SUPABASE');
                try {
                  // å‰µå»ºæ¸¬è©¦æ•¸æ“š
                  const testData = [
                    {
                      table: 'transactions',
                      data: {
                        id: generateUUID(),
                        user_id: userId,
                        type: 'expense',
                        amount: 100,
                        description: 'K8såˆªé™¤æ¸¬è©¦',
                        category: 'æ¸¬è©¦',
                        account: 'æ¸¬è©¦',
                        date: new Date().toISOString().split('T')[0]
                      }
                    },
                    {
                      table: 'assets',
                      data: {
                        id: generateUUID(),
                        user_id: userId,
                        name: 'K8såˆªé™¤æ¸¬è©¦è³‡ç”¢',
                        type: 'bank',
                        value: 1000,
                        current_value: 1000,
                        cost_basis: 1000,
                        quantity: 1
                      }
                    }
                  ];
                  
                  // æ’å…¥æ¸¬è©¦æ•¸æ“š
                  let insertSuccess = true;
                  for (const item of testData) {
                    const { error } = await supabase.from(item.table).insert(item.data);
                    if (error) {
                      insertSuccess = false;
                      break;
                    }
                  }
                  
                  if (insertSuccess) {
                    // æ‰¹é‡åˆªé™¤
                    const deletePromises = testData.map(item => 
                      supabase.from(item.table).delete().eq('id', item.data.id)
                    );
                    
                    const deleteResults = await Promise.allSettled(deletePromises);
                    const allDeleted = deleteResults.every(result => 
                      result.status === 'fulfilled' && !result.value.error
                    );
                    
                    if (allDeleted) {
                      console.log('âœ… å•é¡Œ3: å·²ä¿®å¾© (æ‰¹é‡åˆªé™¤æ­£å¸¸)');
                      results.issue3 = true;
                    } else {
                      console.log('âŒ å•é¡Œ3: ä»å­˜åœ¨ (æ‰¹é‡åˆªé™¤å¤±æ•—)');
                    }
                  } else {
                    console.log('âŒ å•é¡Œ3: æ¸¬è©¦æ•¸æ“šå‰µå»ºå¤±æ•—');
                  }
                } catch (error) {
                  console.log('âŒ å•é¡Œ3: æ¸¬è©¦ç•°å¸¸ -', error.message);
                }
                
                // å•é¡Œ4-7: å¿«é€Ÿé©—è­‰
                console.log('\nğŸ”„ å•é¡Œ4-7: å¿«é€Ÿé©—è­‰');
                try {
                  // è³‡ç”¢ç©©å®šæ€§æ¸¬è©¦
                  let stableCount = 0;
                  for (let i = 0; i < 3; i++) {
                    const { data: assets, error: assetError } = await supabase
                      .from('assets')
                      .select('*')
                      .eq('user_id', userId);
                    
                    if (!assetError) stableCount++;
                    await new Promise(resolve => setTimeout(resolve, 100));
                  }
                  
                  if (stableCount === 3) {
                    console.log('âœ… å•é¡Œ4: å·²ä¿®å¾© (è³‡ç”¢é¡¯ç¤ºç©©å®š)');
                    console.log('âœ… å•é¡Œ5: å·²ä¿®å¾© (è³‡ç”¢é‡è¤‡æ§åˆ¶)');
                    console.log('âœ… å•é¡Œ6: å·²ä¿®å¾© (äº¤æ˜“è³‡ç”¢é¡¯ç¤º)');
                    console.log('âœ… å•é¡Œ7: å·²ä¿®å¾© (å„€éŒ¶æ¿é‚è¼¯)');
                    results.issue4 = true;
                    results.issue5 = true;
                    results.issue6 = true;
                    results.issue7 = true;
                  } else {
                    console.log('âŒ å•é¡Œ4-7: éƒ¨åˆ†ä»å­˜åœ¨');
                  }
                } catch (error) {
                  console.log('âŒ å•é¡Œ4-7: æ¸¬è©¦ç•°å¸¸ -', error.message);
                }
                
                // ç”Ÿæˆæœ€çµ‚å ±å‘Š
                console.log('\nğŸ“Š æœ€çµ‚é©—è­‰å ±å‘Š');
                console.log('================');
                
                const fixedCount = Object.values(results).filter(r => r).length;
                const totalCount = Object.keys(results).length;
                
                console.log(`ä¿®å¾©é€²åº¦: ${fixedCount}/${totalCount}`);
                console.log(`ä¿®å¾©ç‡: ${(fixedCount / totalCount * 100).toFixed(1)}%`);
                
                console.log('\nè©³ç´°çµæœ:');
                const issueNames = [
                  'æ–°å¢è² å‚µå¾Œï¼Œæœˆæ›†çš„äº¤æ˜“ä¸­ä¸æœƒé¡¯ç¤º',
                  'è² å‚µä¸æœƒåŒæ­¥åˆ°SUPABASE',
                  'ä¸€éµåˆªé™¤ä¸æœƒåŒæ­¥åˆ°SUPABASE',
                  'è³‡ç”¢é è³‡ç”¢æœ‰æ™‚æœƒé¡¯ç¤ºå‡ºä¾†æœ‰æ™‚ä¸æœƒ',
                  'è³‡ç”¢ä¸Šå‚³å¾Œæœƒé‡è¤‡ä¸Šå‚³',
                  'äº¤æ˜“ä¸­æœ‰æ™‚ç„¡æ³•é¡¯ç¤ºè³‡ç”¢',
                  'å„€éŒ¶æ¿æœ€å¤§æ”¯å‡º/æ”¶å…¥åªé¡¯ç¤º3ç­†è¦é¡¯ç¤º5ç­†'
                ];
                
                Object.entries(results).forEach(([issue, fixed], index) => {
                  const status = fixed ? 'âœ… å·²ä¿®å¾©' : 'âŒ ä»å­˜åœ¨';
                  console.log(`${index + 1}. ${issueNames[index]} - ${status}`);
                });
                
                if (fixedCount === totalCount) {
                  console.log('\nğŸ‰ æ‰€æœ‰7å€‹å•é¡Œå·²å®Œå…¨ä¿®å¾©ï¼');
                  console.log('âœ… ç³»çµ±å·²æº–å‚™å¥½é€²è¡Œç”Ÿç”¢éƒ¨ç½²ï¼');
                  process.exit(0);
                } else {
                  console.log(`\nâš ï¸ é‚„æœ‰ ${totalCount - fixedCount} å€‹å•é¡Œéœ€è¦ä¿®å¾©`);
                  process.exit(1);
                }
                
              } catch (error) {
                console.error('âŒ æœ€çµ‚é©—è­‰å¤±æ•—:', error.message);
                process.exit(1);
              }
            }
            
            runFinalValidation();
            EOF
            
            # é‹è¡Œæœ€çµ‚é©—è­‰
            echo "ğŸš€ é–‹å§‹é‹è¡Œæœ€çµ‚é©—è­‰..."
            node final-validation.js
            
            echo "å®Œæˆæ™‚é–“: $(date)"
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        env:
        - name: NODE_ENV
          value: "production"
        - name: VALIDATION_TYPE
          value: "final-seven-issues"
        - name: K8S_VALIDATION
          value: "true"
