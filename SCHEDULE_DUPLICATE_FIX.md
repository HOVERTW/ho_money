# 🔧 修正每日自動執行重複問題

## 🚨 發現的問題

用戶發現了一個嚴重的重複執行問題！

### ❌ 原來的問題
每日自動執行時，**所有 5 個台股批次都會同時觸發**：

```yaml
# 所有批次都有相同的 schedule 條件
schedule: '30 6 * * 1-5'  # 台灣時間 14:30

# 每個批次都包含這個條件：
github.event_name == 'schedule' && github.event.schedule == '30 6 * * 1-5'
```

### 🔍 問題分析
```
14:30 自動觸發時：
❌ 批次 1 被觸發 (schedule 條件)
❌ 批次 2 被觸發 (schedule 條件) + needs: update-tw-batch-1
❌ 批次 3 被觸發 (schedule 條件) + needs: update-tw-batch-2  
❌ 批次 4 被觸發 (schedule 條件) + needs: update-tw-batch-3
❌ 批次 5 被觸發 (schedule 條件) + needs: update-tw-batch-4
```

雖然有 `needs` 依賴關係，但**所有批次都會被 schedule 觸發**！

## ✅ 修正方案

### 🎯 修正邏輯
**只讓批次 1 響應 schedule 觸發，其他批次只在手動執行時觸發**

#### 修正前
```yaml
# 所有批次都有 schedule 條件
if: ${{ ... || github.event_name == 'schedule' && github.event.schedule == '30 6 * * 1-5' }}
```

#### 修正後
```yaml
# 只有批次 1 有 schedule 條件
update-tw-batch-1:
  if: ${{ ... || github.event_name == 'schedule' && github.event.schedule == '30 6 * * 1-5' }}

# 批次 2-5 只響應手動觸發
update-tw-batch-2:
  if: ${{ github.event_name == 'workflow_dispatch' && (...) }}
  
update-tw-batch-3:
  if: ${{ github.event_name == 'workflow_dispatch' && (...) }}
  
update-tw-batch-4:
  if: ${{ github.event_name == 'workflow_dispatch' && (...) }}
  
update-tw-batch-5:
  if: ${{ github.event_name == 'workflow_dispatch' && (...) }}
```

## 🔄 修正後的執行邏輯

### 📅 每日自動執行 (14:30)
```
14:30 → 只觸發批次 1
批次 1 完成 → 自動觸發批次 2 (因為 needs 依賴)
批次 2 完成 → 自動觸發批次 3 (因為 needs 依賴)
批次 3 完成 → 自動觸發批次 4 (因為 needs 依賴)
批次 4 完成 → 自動觸發批次 5 (因為 needs 依賴)
批次 5 完成 → 自動觸發美股更新 (因為 needs 依賴)
```

### 🖱️ 手動執行
```bash
# 選擇 "all" 或 "tw"
觸發所有 5 個批次 (順序執行)

# 選擇 "tw-batch-3"  
只觸發批次 3 (獨立執行)
```

## 📊 修正後的條件對照表

| 批次 | Schedule 觸發 | 手動 all/tw | 手動單批次 | 依賴觸發 |
|------|---------------|-------------|------------|----------|
| 批次 1 | ✅ | ✅ | ✅ | - |
| 批次 2 | ❌ | ✅ | ✅ | ✅ (批次1完成) |
| 批次 3 | ❌ | ✅ | ✅ | ✅ (批次2完成) |
| 批次 4 | ❌ | ✅ | ✅ | ✅ (批次3完成) |
| 批次 5 | ❌ | ✅ | ✅ | ✅ (批次4完成) |

## 🎯 預期效果

### ✅ 每日自動執行
```
09:00 → 匯率更新
14:30 → 台股批次1 → 批次2 → 批次3 → 批次4 → 批次5
05:00 → 美股更新 (隔日)

總計：完整覆蓋所有 2100+ 支台股
```

### ✅ 手動執行靈活性
```bash
# 完整更新
選擇 "all" → 所有批次順序執行

# 只更新台股
選擇 "tw" → 台股 5 批次順序執行

# 測試特定批次
選擇 "tw-batch-4" → 只執行批次 4

# 修復失敗批次
選擇對應批次 → 重新執行該批次
```

## 🔍 關鍵改進

### 1. **避免重複觸發**
- ❌ 原來：5 個批次同時被 schedule 觸發
- ✅ 現在：只有批次 1 被 schedule 觸發

### 2. **保持依賴鏈**
- ✅ 批次 1 完成 → 自動觸發批次 2
- ✅ 批次 2 完成 → 自動觸發批次 3
- ✅ 以此類推...

### 3. **維持手動靈活性**
- ✅ 可以手動觸發任何批次組合
- ✅ 可以單獨執行特定批次
- ✅ 可以執行完整流程

## 🚀 測試建議

### 📅 測試自動執行
```bash
# 等待下次 14:30 自動執行
# 觀察是否只有批次 1 被 schedule 觸發
# 確認其他批次通過 needs 依賴順序執行
```

### 🖱️ 測試手動執行
```bash
# 測試完整流程
選擇 "tw" → 確認 5 個批次順序執行

# 測試單批次
選擇 "tw-batch-3" → 確認只執行批次 3
```

## 🎉 修正完成

**問題已修正！** 現在每日自動執行時：
- ✅ 只有批次 1 會被 schedule 觸發
- ✅ 其他批次通過 needs 依賴順序執行
- ✅ 避免了重複觸發問題
- ✅ 保持了手動執行的靈活性

**感謝您發現這個重要問題！** 🙏
