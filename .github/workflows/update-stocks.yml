name: ğŸ“ˆ è‚¡ç¥¨è³‡æ–™æ›´æ–°

on:
  schedule:
    # å°è‚¡æ›´æ–°æ™‚é–“ï¼šå°ç£æ™‚é–“ 14:30 (UTC+8) - å°è‚¡æ”¶ç›¤å¾Œ
    - cron: '30 6 * * 1-5'
    # ç¾è‚¡æ›´æ–°æ™‚é–“ï¼šå°ç£æ™‚é–“ 05:00 (UTC+8) - ç¾è‚¡æ”¶ç›¤å¾Œ
    - cron: '0 21 * * 1-5'
    # åŒ¯ç‡æ›´æ–°ï¼šæ¯æ—¥å°ç£æ™‚é–“ 09:00 (UTC+8)
    - cron: '0 1 * * 1-5'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'é¸æ“‡è¦æ›´æ–°çš„è³‡æ–™é¡å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - tw
          - us
          - rates

jobs:
  # åŒ¯ç‡æ›´æ–°
  update-rates:
    name: ğŸ’± æ›´æ–°åŒ¯ç‡
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'rates') || github.event_name == 'schedule' && github.event.schedule == '0 1 * * 1-5' }}

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£æ ¸å¿ƒä¾è³´
      run: |
        npm install --legacy-peer-deps @supabase/supabase-js@2.39.0 node-fetch@3.3.2 dotenv@16.3.1

    - name: ğŸ’± åŸ·è¡ŒåŒ¯ç‡æ›´æ–°
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: node scripts/update-exchange-rates.js

  # å°è‚¡æ›´æ–° - æ‰¹æ¬¡ 1
  update-tw-batch-1:
    name: ğŸ‡¹ğŸ‡¼ æ›´æ–°å°è‚¡ æ‰¹æ¬¡ 1/3 (æœ€å¤š700æ”¯)
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'tw') || github.event_name == 'schedule' && github.event.schedule == '30 6 * * 1-5' }}

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£æ ¸å¿ƒä¾è³´
      run: |
        npm install --legacy-peer-deps @supabase/supabase-js@2.39.0 node-fetch@3.3.2 dotenv@16.3.1

    - name: ğŸ¢ åŸ·è¡Œå°è‚¡æ›´æ–° - æ‰¹æ¬¡ 1
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        BATCH_NUMBER: 1
        TOTAL_BATCHES: 3
      run: node scripts/update-taiwan-stocks.js

    - name: ğŸ“Š å°è‚¡æ‰¹æ¬¡ 1 æ›´æ–°çµæœ
      if: always()
      run: |
        echo "å°è‚¡æ‰¹æ¬¡ 1/3 æ›´æ–°å®Œæˆ"

  # å°è‚¡æ›´æ–° - æ‰¹æ¬¡ 2
  update-tw-batch-2:
    name: ğŸ‡¹ğŸ‡¼ æ›´æ–°å°è‚¡ æ‰¹æ¬¡ 2/3 (æœ€å¤š700æ”¯)
    runs-on: ubuntu-latest
    needs: update-tw-batch-1
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'tw') || github.event_name == 'schedule' && github.event.schedule == '30 6 * * 1-5' }}

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£æ ¸å¿ƒä¾è³´
      run: |
        npm install --legacy-peer-deps @supabase/supabase-js@2.39.0 node-fetch@3.3.2 dotenv@16.3.1

    - name: ğŸ¢ åŸ·è¡Œå°è‚¡æ›´æ–° - æ‰¹æ¬¡ 2
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        BATCH_NUMBER: 2
        TOTAL_BATCHES: 3
      run: node scripts/update-taiwan-stocks.js

    - name: ğŸ“Š å°è‚¡æ‰¹æ¬¡ 2 æ›´æ–°çµæœ
      if: always()
      run: |
        echo "å°è‚¡æ‰¹æ¬¡ 2/3 æ›´æ–°å®Œæˆ"

  # å°è‚¡æ›´æ–° - æ‰¹æ¬¡ 3
  update-tw-batch-3:
    name: ğŸ‡¹ğŸ‡¼ æ›´æ–°å°è‚¡ æ‰¹æ¬¡ 3/3 (æœ€å¤š700æ”¯)
    runs-on: ubuntu-latest
    needs: update-tw-batch-2
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'tw') || github.event_name == 'schedule' && github.event.schedule == '30 6 * * 1-5' }}

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£æ ¸å¿ƒä¾è³´
      run: |
        npm install --legacy-peer-deps @supabase/supabase-js@2.39.0 node-fetch@3.3.2 dotenv@16.3.1

    - name: ğŸ¢ åŸ·è¡Œå°è‚¡æ›´æ–° - æ‰¹æ¬¡ 3
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        BATCH_NUMBER: 3
        TOTAL_BATCHES: 3
      run: node scripts/update-taiwan-stocks.js

    - name: ğŸ“Š å°è‚¡æ‰¹æ¬¡ 3 æ›´æ–°çµæœ
      if: always()
      run: |
        echo "å°è‚¡æ‰¹æ¬¡ 3/3 æ›´æ–°å®Œæˆ - æ‰€æœ‰å°è‚¡æ›´æ–°å®Œæˆï¼"

  # ç¾è‚¡æ›´æ–°
  update-us:
    name: ğŸ‡ºğŸ‡¸ æ›´æ–°ç¾è‚¡ (Yahoo Finance)
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'us') || github.event_name == 'schedule' && github.event.schedule == '0 21 * * 1-5' }}

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£æ ¸å¿ƒä¾è³´
      run: |
        npm install --legacy-peer-deps @supabase/supabase-js@2.39.0 node-fetch@3.3.2 dotenv@16.3.1 csv-parse@5.6.0

    - name: ğŸ¢ åŸ·è¡Œç¾è‚¡æ›´æ–°
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: node scripts/update-us-stocks.js

    - name: ğŸ“Š ç¾è‚¡æ›´æ–°çµæœ
      if: always()
      run: |
        echo "ç¾è‚¡æ›´æ–°å®Œæˆ - ä½¿ç”¨ Yahoo Finance API"
