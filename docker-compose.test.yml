version: '3.8'

services:
  # Web ç’°å¢ƒæ¸¬è©¦
  fintranzo-web-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      target: development
    ports:
      - "8080:80"
      - "8081:8081"
    environment:
      - NODE_ENV=development
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2MzI4NzEsImV4cCI6MjA1MTIwODg3MX0.Ey6Nt9TgKJVLJOJQjKpJxJQJQJQJQJQJQJQJQJQJQJQ
      - EXPO_PUBLIC_REDIRECT_URL=http://localhost:8081
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ³ å•Ÿå‹• Web æ¸¬è©¦ç’°å¢ƒ...' &&
        npm install &&
        echo 'ğŸ§ª é‹è¡Œäº”å¤§å•é¡Œä¿®å¾©æ¸¬è©¦...' &&
        node scripts/docker-kubernetes-five-issues-fix-test.js &&
        echo 'ğŸŒ å•Ÿå‹• Web æœå‹™...' &&
        npx expo start --web --port 8081
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3

  # iOS æ¨¡æ“¬å™¨ç’°å¢ƒæ¸¬è©¦
  fintranzo-ios-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.ios-simulator
    ports:
      - "19000:19000"
      - "19001:19001"
    environment:
      - NODE_ENV=development
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2MzI4NzEsImV4cCI6MjA1MTIwODg3MX0.Ey6Nt9TgKJVLJOJQjKpJxJQJQJQJQJQJQJQJQJQJQJQ
      - EXPO_PUBLIC_REDIRECT_URL=http://localhost:19000
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ“± å•Ÿå‹• iOS æ¨¡æ“¬å™¨æ¸¬è©¦ç’°å¢ƒ...' &&
        npm install &&
        echo 'ğŸ§ª é‹è¡Œäº”å¤§å•é¡Œä¿®å¾©æ¸¬è©¦...' &&
        node scripts/docker-kubernetes-five-issues-fix-test.js &&
        echo 'ğŸ“± å•Ÿå‹• iOS æ¨¡æ“¬å™¨...' &&
        npx expo start --port 19000
      "

  # ç´”æ¸¬è©¦ç’°å¢ƒï¼ˆä¸å•Ÿå‹•æœå‹™ï¼‰
  fintranzo-test-only:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      target: development
    environment:
      - NODE_ENV=test
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2MzI4NzEsImV4cCI6MjA1MTIwODg3MX0.Ey6Nt9TgKJVLJOJQjKpJxJQJQJQJQJQJQJQJQJQJQJQ
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ§ª ç´”æ¸¬è©¦ç’°å¢ƒ - äº”å¤§å•é¡Œä¿®å¾©æ¸¬è©¦' &&
        npm install &&
        echo 'ğŸ“Š é–‹å§‹æ¸¬è©¦...' &&
        node scripts/docker-kubernetes-five-issues-fix-test.js &&
        echo 'âœ… æ¸¬è©¦å®Œæˆ'
      "

  # 10è¼ªæ¸¬è©¦ç’°å¢ƒ
  fintranzo-10-rounds-test:
    build:
      context: .
      dockerfile: docker/Dockerfile.web
      target: development
    environment:
      - NODE_ENV=test
      - EXPO_PUBLIC_SUPABASE_URL=https://yrryyapzkgrsahranzvo.supabase.co
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlycnl5YXB6a2dyc2FocmFuenZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2MzI4NzEsImV4cCI6MjA1MTIwODg3MX0.Ey6Nt9TgKJVLJOJQjKpJxJQJQJQJQJQJQJQJQJQJQJQ
    volumes:
      - .:/app
      - /app/node_modules
    command: >
      sh -c "
        echo 'ğŸ”„ 10è¼ªæ¸¬è©¦ç’°å¢ƒ - äº”å¤§å•é¡Œä¿®å¾©æ¸¬è©¦' &&
        npm install &&
        for i in \$$(seq 1 10); do
          echo \"ğŸ“Š ç¬¬ \$$i è¼ªæ¸¬è©¦é–‹å§‹...\" &&
          node scripts/docker-kubernetes-five-issues-fix-test.js &&
          echo \"âœ… ç¬¬ \$$i è¼ªæ¸¬è©¦å®Œæˆ\" &&
          sleep 2
        done &&
        echo 'ğŸ‰ 10è¼ªæ¸¬è©¦å…¨éƒ¨å®Œæˆ'
      "

networks:
  default:
    driver: bridge

volumes:
  node_modules:
    driver: local
