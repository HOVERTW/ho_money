version: '3.8'

services:
  # WEB ç’°å¢ƒæ¸¬è©¦
  web-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    container_name: fintranzo-web-test
    environment:
      - PLATFORM=web
      - NODE_ENV=test
      - EXPO_PUBLIC_SUPABASE_URL=${EXPO_PUBLIC_SUPABASE_URL}
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=${EXPO_PUBLIC_SUPABASE_ANON_KEY}
    ports:
      - "3000:3000"
    volumes:
      - ../src:/app/src:ro
      - ../scripts:/app/scripts:ro
      - ./test-results:/app/test-results
    command: >
      bash -c "
        echo 'ğŸŒ WEB ç’°å¢ƒæ¸¬è©¦é–‹å§‹'
        npm run build:web || echo 'âŒ WEB æ§‹å»ºå¤±æ•—'
        npm run test:delete:web || echo 'âŒ WEB åˆªé™¤æ¸¬è©¦å¤±æ•—'
        echo 'âœ… WEB ç’°å¢ƒæ¸¬è©¦å®Œæˆ'
      "
    networks:
      - test-network

  # iOS ç’°å¢ƒæ¸¬è©¦
  ios-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    container_name: fintranzo-ios-test
    environment:
      - PLATFORM=ios
      - NODE_ENV=test
      - EXPO_PUBLIC_SUPABASE_URL=${EXPO_PUBLIC_SUPABASE_URL}
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=${EXPO_PUBLIC_SUPABASE_ANON_KEY}
    volumes:
      - ../src:/app/src:ro
      - ../scripts:/app/scripts:ro
      - ./test-results:/app/test-results
    command: >
      bash -c "
        echo 'ğŸ“± iOS ç’°å¢ƒæ¸¬è©¦é–‹å§‹'
        npm run test:delete:ios || echo 'âŒ iOS åˆªé™¤æ¸¬è©¦å¤±æ•—'
        echo 'âœ… iOS ç’°å¢ƒæ¸¬è©¦å®Œæˆ'
      "
    networks:
      - test-network

  # åˆªé™¤åŠŸèƒ½å°ˆé …æ¸¬è©¦
  delete-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile.test
    container_name: fintranzo-delete-test
    environment:
      - NODE_ENV=test
      - EXPO_PUBLIC_SUPABASE_URL=${EXPO_PUBLIC_SUPABASE_URL}
      - EXPO_PUBLIC_SUPABASE_ANON_KEY=${EXPO_PUBLIC_SUPABASE_ANON_KEY}
    volumes:
      - ../src:/app/src:ro
      - ../scripts:/app/scripts:ro
      - ./test-results:/app/test-results
    command: >
      bash -c "
        echo 'ğŸ—‘ï¸ åˆªé™¤åŠŸèƒ½å°ˆé …æ¸¬è©¦é–‹å§‹'
        node scripts/test-new-delete-system.js || echo 'âŒ æ–°åˆªé™¤ç³»çµ±æ¸¬è©¦å¤±æ•—'
        echo 'âœ… åˆªé™¤åŠŸèƒ½å°ˆé …æ¸¬è©¦å®Œæˆ'
      "
    depends_on:
      - web-test
      - ios-test
    networks:
      - test-network

networks:
  test-network:
    driver: bridge

volumes:
  test-results:
